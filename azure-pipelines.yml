trigger:
- master

variables:
- name: system.debug
  value: true 

pool:
  vmImage: windows-latest

steps:

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      curl -O -L https://download.oracle.com/java/19/archive/jdk-19.0.2_windows-x64_bin.zip

- task: CopyFiles@2
  inputs:
    Contents: 'jdk-19.0.2_windows-x64_bin.zip'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)'
    artifactName: Java19
  
- task: JavaToolInstaller@1
  inputs:
    versionSpec: "19"
    jdkArchitectureOption: x64
    jdkSourceOption: LocalDirectory
    jdkFile: '$(Build.ArtifactStagingDirectory)/jdk-19.0.2_windows-x64_bin.zip'
    jdkDestinationDirectory: '/builds/binaries/externals'

- task: SonarQubePrepare@6
  inputs:
    SonarQube: 'lurodrig-sonarqube.ngrok.io'
    projectKey: 'unit-testing-using-dotnet-test'
    projectName: 'unit-testing-using-dotnet-test'
    extraProperties: | 
      sonar.verbose=true
  displayName: 'SonarQube Prepare'

- task: NuGetCommand@2
  inputs:
    command: 'restore'
    restoreSolution: '**/*.sln'
    feedsToUse: 'select'

- task: VSBuild@1
  inputs:
   solution: 'unit-testing-using-dotnet-test.sln'
   logFileVerbosity: 'detailed'
   vsVersion: '17.0'

- task: VSTest@2
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
        **\*test*.dll
        !**\*Microsoft*.dll
        !**\*testcentric*.dll
        !**\*TestUtilities*.dll
        !**\TestableIO*.dll
        !**\*LeakTest*.dll
        !**\obj\**
    searchFolder: 'PrimeService.Tests'
    codeCoverageEnabled: true
    diagnosticsEnabled: true
    vsTestVersion: '17.0'

- task: SonarQubeAnalyze@6
  inputs:
    jdkversion: 'JAVA_HOME'
